
# Rescue benzodiazepine transitions








## 1. Preparation of software for analysis




Install needed packages
```{r}
# install.packages("dplyr")
library(dplyr)

# install.packages("dbplyr")
library(dbplyr)

# install.packages("tidyr")
library(tidyr)

# install.packages("RSQLite")
library(RSQLite)

# install.packages("tibble")
library(tibble)

# install.packages("haven")
library(haven)

# install.packages("lubridate")
library(lubridate)

# install.packages("gmodels")
library(gmodels)

# install.packages("bazar")
library(bazar)

# install.packages("DescTools")
library(DescTools)

# install.packages("ggplot2")
library(ggplot2)

# install.packages("plotly")
library(plotly)

# install.packages("survival")
library(survival)
```








## 2. Data ingestion




Create the connection to the database
```{r}
# Create the connection to the MarketScan database
MarketScan <- DBI::dbConnect(RSQLite::SQLite(), "D:\\MarketScan\\MarketScan.db")
src_dbi(MarketScan)
```




Create the link to the relevant tables
```{r}
# Year 2016
ms_i_2016 <- tbl(MarketScan, "ms_i_2016")
ms_s_2016 <- tbl(MarketScan, "ms_s_2016")
ms_d_2016 <- tbl(MarketScan, "ms_d_2016")
ms_o_2016 <- tbl(MarketScan, "ms_o_2016")
ms_a_2016 <- tbl(MarketScan, "ms_a_2016")
ms_t_2016 <- tbl(MarketScan, "ms_t_2016")
redbook_2016 <- tbl(MarketScan, "redbook_2016")

# Year 2017
ms_i_2017 <- tbl(MarketScan, "ms_i_2017")
ms_s_2017 <- tbl(MarketScan, "ms_s_2017")
ms_d_2017 <- tbl(MarketScan, "ms_d_2017")
ms_o_2017 <- tbl(MarketScan, "ms_o_2017")
ms_a_2017 <- tbl(MarketScan, "ms_a_2017")
ms_t_2017 <- tbl(MarketScan, "ms_t_2017")
redbook_2017 <- tbl(MarketScan, "redbook_2017")

# Year 2018
ms_i_2018 <- tbl(MarketScan, "ms_i_2018")
ms_s_2018 <- tbl(MarketScan, "ms_s_2018")
ms_d_2018 <- tbl(MarketScan, "ms_d_2018")
ms_o_2018 <- tbl(MarketScan, "ms_o_2018")
ms_a_2018 <- tbl(MarketScan, "ms_a_2018")
ms_t_2018 <- tbl(MarketScan, "ms_t_2018")
redbook_2018 <- tbl(MarketScan, "redbook_2018")

# Year 2019
ms_i_2019 <- tbl(MarketScan, "ms_i_2019")
ms_s_2019 <- tbl(MarketScan, "ms_s_2019")
ms_d_2019 <- tbl(MarketScan, "ms_d_2019")
ms_o_2019 <- tbl(MarketScan, "ms_o_2019")
ms_a_2019 <- tbl(MarketScan, "ms_a_2019")
ms_t_2019 <- tbl(MarketScan, "ms_t_2019")
redbook_2019 <- tbl(MarketScan, "redbook_2019")

# Year 2020
ms_i_2020 <- tbl(MarketScan, "ms_i_2020")
ms_s_2020 <- tbl(MarketScan, "ms_s_2020")
ms_d_2020 <- tbl(MarketScan, "ms_d_2020")
ms_o_2020 <- tbl(MarketScan, "ms_o_2020")
ms_a_2020 <- tbl(MarketScan, "ms_a_2020")
ms_t_2020 <- tbl(MarketScan, "ms_t_2020")
redbook_2020 <- tbl(MarketScan, "redbook_2020")

# Year 2021
ms_i_2021 <- tbl(MarketScan, "ms_i_2021")
ms_s_2021 <- tbl(MarketScan, "ms_s_2021")
ms_d_2021 <- tbl(MarketScan, "ms_d_2021")
ms_o_2021 <- tbl(MarketScan, "ms_o_2021")
ms_a_2021 <- tbl(MarketScan, "ms_a_2021")
ms_t_2021 <- tbl(MarketScan, "ms_t_2021")
redbook_2021 <- tbl(MarketScan, "redbook_2021")

# Year 2022
ms_i_2022 <- tbl(MarketScan, "ms_i_2022")
ms_s_2022 <- tbl(MarketScan, "ms_s_2022")
ms_d_2022 <- tbl(MarketScan, "ms_d_2022")
ms_o_2022 <- tbl(MarketScan, "ms_o_2022")
ms_a_2022 <- tbl(MarketScan, "ms_a_2022")
ms_t_2022 <- tbl(MarketScan, "ms_t_2022")
redbook_2022 <- tbl(MarketScan, "redbook_2022")
```




Information on antiseizure medications
```{r}
# Extract the information from the redbook data
redbook_2016_data <- redbook_2016 %>% collect()
redbook_2017_data <- redbook_2017 %>% collect()
redbook_2018_data <- redbook_2018 %>% collect()
redbook_2019_data <- redbook_2019 %>% collect()
redbook_2020_data <- redbook_2020 %>% collect()
redbook_2021_data <- redbook_2021 %>% collect()
redbook_2022_data <- redbook_2022 %>% collect()
```




Rescue medications
```{r}
# NDCNUM codes for rectal diazepam
codes_NDCNUM_rectal_DZP_2016 <- redbook_2016_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2016 <- as.numeric(codes_NDCNUM_rectal_DZP_2016)


codes_NDCNUM_rectal_DZP_2017 <- redbook_2017_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2017 <- as.numeric(codes_NDCNUM_rectal_DZP_2017)


codes_NDCNUM_rectal_DZP_2018 <- redbook_2018_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2018 <- as.numeric(codes_NDCNUM_rectal_DZP_2018)


codes_NDCNUM_rectal_DZP_2019 <- redbook_2019_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2019 <- as.numeric(codes_NDCNUM_rectal_DZP_2019)


codes_NDCNUM_rectal_DZP_2020 <- redbook_2020_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2020 <- as.numeric(codes_NDCNUM_rectal_DZP_2020)


codes_NDCNUM_rectal_DZP_2021 <- redbook_2021_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2021 <- as.numeric(codes_NDCNUM_rectal_DZP_2021)


codes_NDCNUM_rectal_DZP_2022 <- redbook_2022_data %>% 
  filter(
      grepl("diastat", PRODNME, ignore.case=TRUE) |
      grepl("diazepam rectal", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rectal", ROADS, ignore.case=TRUE)  ) |     
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("rc", ROACD, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_rectal_DZP_2022 <- as.numeric(codes_NDCNUM_rectal_DZP_2022)




# NDCNUM codes for intranasal midazolam
codes_NDCNUM_intranasal_MDZ_2016 <- redbook_2016_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2016 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2016)


codes_NDCNUM_intranasal_MDZ_2017 <- redbook_2017_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2017 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2017)


codes_NDCNUM_intranasal_MDZ_2018 <- redbook_2018_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2018 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2018)


codes_NDCNUM_intranasal_MDZ_2019 <- redbook_2019_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2019 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2019)


codes_NDCNUM_intranasal_MDZ_2020 <- redbook_2020_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2020 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2020)


codes_NDCNUM_intranasal_MDZ_2021 <- redbook_2021_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2021 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2021)


codes_NDCNUM_intranasal_MDZ_2022 <- redbook_2022_data %>% 
  filter(
      grepl("nayzilam", PRODNME, ignore.case=TRUE) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("midazolam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_MDZ_2022 <- as.numeric(codes_NDCNUM_intranasal_MDZ_2022)




# NDCNUM codes for intranasal diazepam
codes_NDCNUM_intranasal_DZP_2016 <- redbook_2016_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2016 <- as.numeric(codes_NDCNUM_intranasal_DZP_2016)


codes_NDCNUM_intranasal_DZP_2017 <- redbook_2017_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2017 <- as.numeric(codes_NDCNUM_intranasal_DZP_2017)


codes_NDCNUM_intranasal_DZP_2018 <- redbook_2018_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2018 <- as.numeric(codes_NDCNUM_intranasal_DZP_2018)


codes_NDCNUM_intranasal_DZP_2019 <- redbook_2019_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2019 <- as.numeric(codes_NDCNUM_intranasal_DZP_2019)


codes_NDCNUM_intranasal_DZP_2020 <- redbook_2020_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2020 <- as.numeric(codes_NDCNUM_intranasal_DZP_2020)


codes_NDCNUM_intranasal_DZP_2021 <- redbook_2021_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2021 <- as.numeric(codes_NDCNUM_intranasal_DZP_2021)


codes_NDCNUM_intranasal_DZP_2022 <- redbook_2022_data %>% 
  filter(
      grepl("valtoco", PRODNME, ignore.case=TRUE) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", GENNME, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("nasal", ROADS, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("NS", ROACD, ignore.case=TRUE)  ) |
      ( grepl("diazepam", THRDTDS, ignore.case=TRUE) & grepl("SPR", MASTFRM, ignore.case=TRUE)  )
    ) %>% 
  pull(NDCNUM)
codes_NDCNUM_intranasal_DZP_2022 <- as.numeric(codes_NDCNUM_intranasal_DZP_2022)
```




Patients with at least one rescue medication prescribed
```{r}
# Rescue medications
####################################2016####################################
rescue_medication_2016 <- ms_d_2016 %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2016) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2016) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2016) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2016 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2016 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2016 ~ "intranasal diazepam"))


####################################2017####################################
rescue_medication_2017 <- ms_d_2017 %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2017) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2017) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2017) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2017 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2017 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2017 ~ "intranasal diazepam"))


####################################2018####################################
rescue_medication_2018 <- ms_d_2018 %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2018) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2018) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2018) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2018 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2018 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2018 ~ "intranasal diazepam"))


####################################2019####################################
rescue_medication_2019 <- ms_d_2019 %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2019) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2019) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2019) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2019 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2019 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2019 ~ "intranasal diazepam"))


####################################2020####################################
rescue_medication_2020 <- ms_d_2020 %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2020) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2020) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2020) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2020 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2020 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2020 ~ "intranasal diazepam"))


####################################2021####################################
rescue_medication_2021 <- ms_d_2021 %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2021) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2021) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2021) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2021 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2021 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2021 ~ "intranasal diazepam"))


####################################2022####################################
rescue_medication_2022 <- ms_d_2022 %>% 
  filter( (NDCNUM %in% codes_NDCNUM_rectal_DZP_2022) | (NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2022) | (NDCNUM %in% codes_NDCNUM_intranasal_DZP_2022) )  %>%
  select(ENROLID, SVCDATE, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(across(c(ENROLID, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY), as.numeric)) %>%
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  rename(rescue_medication_prescription_date = SVCDATE) %>% 
  mutate(rescue_medication = case_when(
    NDCNUM %in% codes_NDCNUM_rectal_DZP_2022 ~ "rectal diazepam",
    NDCNUM %in% codes_NDCNUM_intranasal_MDZ_2022 ~ "intranasal midazolam",
    NDCNUM %in% codes_NDCNUM_intranasal_DZP_2022 ~ "intranasal diazepam"))




# Rescue medication
rescue_medication <- bind_rows(rescue_medication_2016, rescue_medication_2017, rescue_medication_2018, rescue_medication_2019, rescue_medication_2020, rescue_medication_2021, rescue_medication_2022) %>% 
  mutate(rescue_medication = factor(rescue_medication)) %>%    
  mutate(GENIND = factor(GENIND)) %>% 
  mutate(RXMR = factor(RXMR)) %>%           
  arrange(ENROLID, rescue_medication_prescription_date) %>% 
  distinct(ENROLID, rescue_medication_prescription_date, .keep_all=TRUE) %>% 
  mutate(year_rescue_medication=year(rescue_medication_prescription_date)) %>% 
  select(ENROLID, rescue_medication_prescription_date, GENIND, METQTY, rescue_medication, year_rescue_medication, AWP, COB, COINS, COPAY, DEDUCT, DISPFEE, GENERID, INGCOST, NETPAY, PAY, SALETAX, GENIND, DAYSUPP, RXMR, NDCNUM, METQTY) %>% 
  mutate(prepost = case_when(
    rescue_medication_prescription_date < as.Date("2019-12-1") ~ "pre",
    TRUE ~ "post")) %>% 
  group_by(ENROLID) %>%
  filter(all(c("pre", "post") %in% prepost)) %>% 
  ungroup() %>% 
  collect()




rescue_medication_ID <- rescue_medication %>% distinct(ENROLID)
rescue_medication_ID %>% nrow()
```




Extract information for demographics
```{r}
# Extract information from demographics 
#################################2016#################################
demographics_2016 <- ms_t_2016 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2017#################################
demographics_2017 <- ms_t_2017 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2018#################################
demographics_2018 <- ms_t_2018 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2019#################################
demographics_2019 <- ms_t_2019 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2020#################################
demographics_2020 <- ms_t_2020 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2021#################################
demographics_2021 <- ms_t_2021 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()


#################################2022#################################
demographics_2022 <- ms_t_2022 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>%
  select(ENROLID, SEX, DOBYR, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, DTSTART, DTEND, MEMDAYS, INDSTRY, MSA) %>% 
  mutate(across(c(ENROLID, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, MEMDAYS, MSA), as.numeric)) %>% 
  collect()




# Demographics
demographics <- bind_rows(demographics_2016, demographics_2017, demographics_2018, demographics_2019, demographics_2020, demographics_2021, demographics_2022) %>% 
  mutate(across(ENROLID, as.numeric)) %>% 
  filter(ENROLID>0) %>%    
  arrange(ENROLID, DTSTART) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, DOBYR, SEX, REGION, EECLASS, EESTATU, EMPREL, EGEOLOC, INDSTRY, MSA) %>% 
  collect()
```




Adjustment for inflation
```{r}
# Inflation calculations (https://apps.bea.gov/iTable/?reqid=19&step=2&isuri=1&categories=survey#eyJhcHBpZCI6MTksInN0ZXBzIjpbMSwyLDMsM10sImRhdGEiOltbImNhdGVnb3JpZXMiLCJTdXJ2ZXkiXSxbIk5JUEFfVGFibGVfTGlzdCIsIjEzIl0sWyJGaXJzdF9ZZWFyIiwiMjAwNiJdLFsiTGFzdF9ZZWFyIiwiMjAyMiJdLFsiU2NhbGUiLCIwIl0sWyJTZXJpZXMiLCJRIl1dfQ== Last accessed 9/17/2023)
# https://meps.ahrq.gov/about_meps/Price_Index.shtml
inflation_2016_Q1 <- 1.04895
inflation_2016_Q2 <- 1.05636	
inflation_2016_Q3 <- 1.05929
inflation_2016_Q4 <- 1.06487
inflation_2017_Q1 <- 1.07038
inflation_2017_Q2 <- 1.07371		
inflation_2017_Q3 <- 1.07910
inflation_2017_Q4 <- 1.08653	
inflation_2018_Q1 <- 1.09320
inflation_2018_Q2 <- 1.10258		
inflation_2018_Q3 <- 1.10629
inflation_2018_Q4 <- 1.11132		
inflation_2019_Q1 <- 1.11562
inflation_2019_Q2 <- 1.12184		
inflation_2019_Q3 <- 1.12550
inflation_2019_Q4 <- 1.12963	
inflation_2020_Q1 <- 1.13418
inflation_2020_Q2 <- 1.12993		
inflation_2020_Q3 <- 1.13971
inflation_2020_Q4 <- 1.14692
inflation_2021_Q1 <- 1.16120	
inflation_2021_Q2 <- 1.17922		
inflation_2021_Q3 <- 1.19712
inflation_2021_Q4 <- 1.21708
inflation_2022_Q1 <- 1.24174	
inflation_2022_Q2 <- 1.26907		
inflation_2022_Q3 <- 1.28269
inflation_2022_Q4 <- 1.29508


# Cost adjusted for inflation (to Q4 2022 year, the most recent available quarter at the time of writing)
inflation_adjusted_rescue_medication <- rescue_medication %>% 
  mutate(year_quarter = quarter(rescue_medication_prescription_date, with_year=TRUE)) %>%
  mutate(
    AWP = case_when(
  year_quarter == 2016.1 ~ AWP*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ AWP*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ AWP*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ AWP*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ AWP*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ AWP*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ AWP*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ AWP*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ AWP*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ AWP*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ AWP*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ AWP*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ AWP*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ AWP*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ AWP*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ AWP*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ AWP*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ AWP*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ AWP*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ AWP*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ AWP*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ AWP*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ AWP*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ AWP*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ AWP*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ AWP*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ AWP*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ AWP*(inflation_2022_Q4/inflation_2022_Q4)),
    COB = case_when(
  year_quarter == 2016.1 ~ COB*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ COB*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ COB*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ COB*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ COB*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ COB*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ COB*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ COB*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ COB*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ COB*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ COB*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ COB*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ COB*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ COB*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ COB*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ COB*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ COB*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ COB*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ COB*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ COB*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ COB*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ COB*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ COB*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ COB*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ COB*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ COB*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ COB*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ COB*(inflation_2022_Q4/inflation_2022_Q4)),
    COINS = case_when(
  year_quarter == 2016.1 ~ COINS*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ COINS*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ COINS*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ COINS*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ COINS*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ COINS*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ COINS*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ COINS*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ COINS*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ COINS*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ COINS*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ COINS*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ COINS*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ COINS*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ COINS*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ COINS*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ COINS*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ COINS*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ COINS*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ COINS*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ COINS*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ COINS*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ COINS*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ COINS*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ COINS*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ COINS*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ COINS*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ COINS*(inflation_2022_Q4/inflation_2022_Q4)),
    COPAY = case_when(
  year_quarter == 2016.1 ~ COPAY*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ COPAY*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ COPAY*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ COPAY*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ COPAY*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ COPAY*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ COPAY*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ COPAY*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ COPAY*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ COPAY*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ COPAY*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ COPAY*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ COPAY*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ COPAY*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ COPAY*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ COPAY*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ COPAY*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ COPAY*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ COPAY*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ COPAY*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ COPAY*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ COPAY*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ COPAY*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ COPAY*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ COPAY*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ COPAY*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ COPAY*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ COPAY*(inflation_2022_Q4/inflation_2022_Q4)),
    DEDUCT = case_when(
  year_quarter == 2016.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ DEDUCT*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ DEDUCT*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ DEDUCT*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ DEDUCT*(inflation_2022_Q4/inflation_2022_Q4)),
    DISPFEE = case_when(
  year_quarter == 2016.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ DISPFEE*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ DISPFEE*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ DISPFEE*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ DISPFEE*(inflation_2022_Q4/inflation_2022_Q4)),
    INGCOST = case_when(
  year_quarter == 2016.1 ~ INGCOST*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ INGCOST*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ INGCOST*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ INGCOST*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ INGCOST*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ INGCOST*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ INGCOST*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ INGCOST*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ INGCOST*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ INGCOST*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ INGCOST*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ INGCOST*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ INGCOST*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ INGCOST*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ INGCOST*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ INGCOST*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ INGCOST*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ INGCOST*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ INGCOST*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ INGCOST*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ INGCOST*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ INGCOST*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ INGCOST*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ INGCOST*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ INGCOST*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ INGCOST*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ INGCOST*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ INGCOST*(inflation_2022_Q4/inflation_2022_Q4)),
    NETPAY = case_when(
  year_quarter == 2016.1 ~ NETPAY*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ NETPAY*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ NETPAY*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ NETPAY*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ NETPAY*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ NETPAY*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ NETPAY*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ NETPAY*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ NETPAY*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ NETPAY*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ NETPAY*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ NETPAY*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ NETPAY*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ NETPAY*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ NETPAY*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ NETPAY*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ NETPAY*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ NETPAY*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ NETPAY*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ NETPAY*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ NETPAY*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ NETPAY*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ NETPAY*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ NETPAY*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ NETPAY*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ NETPAY*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ NETPAY*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ NETPAY*(inflation_2022_Q4/inflation_2022_Q4)),
    PAY = case_when(
  year_quarter == 2016.1 ~ PAY*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ PAY*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ PAY*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ PAY*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ PAY*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ PAY*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ PAY*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ PAY*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ PAY*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ PAY*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ PAY*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ PAY*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ PAY*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ PAY*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ PAY*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ PAY*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ PAY*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ PAY*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ PAY*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ PAY*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ PAY*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ PAY*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ PAY*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ PAY*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ PAY*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ PAY*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ PAY*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ PAY*(inflation_2022_Q4/inflation_2022_Q4)),  
    SALETAX = case_when(
  year_quarter == 2016.1 ~ SALETAX*(inflation_2022_Q4/inflation_2016_Q1), 
  year_quarter == 2016.2 ~ SALETAX*(inflation_2022_Q4/inflation_2016_Q2),
  year_quarter == 2016.3 ~ SALETAX*(inflation_2022_Q4/inflation_2016_Q3),
  year_quarter == 2016.4 ~ SALETAX*(inflation_2022_Q4/inflation_2016_Q4), 
  year_quarter == 2017.1 ~ SALETAX*(inflation_2022_Q4/inflation_2017_Q1), 
  year_quarter == 2017.2 ~ SALETAX*(inflation_2022_Q4/inflation_2017_Q2),
  year_quarter == 2017.3 ~ SALETAX*(inflation_2022_Q4/inflation_2017_Q3),
  year_quarter == 2017.4 ~ SALETAX*(inflation_2022_Q4/inflation_2017_Q4), 
  year_quarter == 2018.1 ~ SALETAX*(inflation_2022_Q4/inflation_2018_Q1), 
  year_quarter == 2018.2 ~ SALETAX*(inflation_2022_Q4/inflation_2018_Q2),
  year_quarter == 2018.3 ~ SALETAX*(inflation_2022_Q4/inflation_2018_Q3),
  year_quarter == 2018.4 ~ SALETAX*(inflation_2022_Q4/inflation_2018_Q4), 
  year_quarter == 2019.1 ~ SALETAX*(inflation_2022_Q4/inflation_2019_Q1), 
  year_quarter == 2019.2 ~ SALETAX*(inflation_2022_Q4/inflation_2019_Q2),
  year_quarter == 2019.3 ~ SALETAX*(inflation_2022_Q4/inflation_2019_Q3),
  year_quarter == 2019.4 ~ SALETAX*(inflation_2022_Q4/inflation_2019_Q4),
  year_quarter == 2020.1 ~ SALETAX*(inflation_2022_Q4/inflation_2020_Q1), 
  year_quarter == 2020.2 ~ SALETAX*(inflation_2022_Q4/inflation_2020_Q2),
  year_quarter == 2020.3 ~ SALETAX*(inflation_2022_Q4/inflation_2020_Q3),
  year_quarter == 2020.4 ~ SALETAX*(inflation_2022_Q4/inflation_2020_Q4),
  year_quarter == 2021.1 ~ SALETAX*(inflation_2022_Q4/inflation_2021_Q1), 
  year_quarter == 2021.2 ~ SALETAX*(inflation_2022_Q4/inflation_2021_Q2),
  year_quarter == 2021.3 ~ SALETAX*(inflation_2022_Q4/inflation_2021_Q3),
  year_quarter == 2021.4 ~ SALETAX*(inflation_2022_Q4/inflation_2021_Q4),
  year_quarter == 2022.1 ~ SALETAX*(inflation_2022_Q4/inflation_2022_Q1), 
  year_quarter == 2022.2 ~ SALETAX*(inflation_2022_Q4/inflation_2022_Q2),
  year_quarter == 2022.3 ~ SALETAX*(inflation_2022_Q4/inflation_2022_Q3),
  year_quarter == 2022.4 ~ SALETAX*(inflation_2022_Q4/inflation_2022_Q4))    
  ) %>% 
    collect()
inflation_adjusted_rescue_medication
```




Identify patients with a code for epilepsy, febrile seizures, or neither
```{r}
# Codes for patients with epilepsy, febrile seizures, or neither
codes_epilepsy_ICD10 <- c("G40", "G400", "G4000", "G40001", "G40009", "G4001", "G40011", "G40019", "G401", "G4010", "G40101", "G40109", "G4011", "G40111", "G40119", "G402", "G4020", "G40201", "G40209", "G4021", "G40211", "G40219", "G403", "G4030", "G40301", "G40309", "G4031", "G40311", "G40319", "G40A", "G40A0", "G40A01", "G40A09", "G40A1", "G40A11", "G40A19", "G40B", "G40B0", "G40B01", "G40B09", "G40B1", "G40B11", "G40B19", "G404", "G4040", "G40401", "G40409", "G4041", "G40411", "G40419", "G408", "G4080", "G40801", "G40802", "G40803", "G40804", "G4081", "G40811", "G40812", "G40813", "G40814", "G4082", "G40821", "G40822", "G40823", "G40824", "G4083", "G40833", "G40834", "G409", "G4090", "G40901", "G40909", "G4091", "G40911", "G40919")


# Codes for patients with febrile seizures
code_febrile_seizures_ICD10 <- c("R5600", "R5601")




# Patients with epilepsy or febrile seizures
#################################2016#################################
epilepsy_febrile_seizure_2016_i <- ms_i_2016 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)

epilepsy_febrile_seizure_2016_o <- ms_o_2016 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)  

epilepsy_febrile_seizure_2016_s <- ms_s_2016 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)    
  
  


#################################2017#################################
epilepsy_febrile_seizure_2017_i <- ms_i_2017 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)

epilepsy_febrile_seizure_2017_o <- ms_o_2017 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)  

epilepsy_febrile_seizure_2017_s <- ms_s_2017 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)    
  
  


#################################2018#################################
epilepsy_febrile_seizure_2018_i <- ms_i_2018 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)

epilepsy_febrile_seizure_2018_o <- ms_o_2018 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)  

epilepsy_febrile_seizure_2018_s <- ms_s_2018 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)    
  
  


#################################2019#################################
epilepsy_febrile_seizure_2019_i <- ms_i_2019 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)

epilepsy_febrile_seizure_2019_o <- ms_o_2019 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)  

epilepsy_febrile_seizure_2019_s <- ms_s_2019 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)    
  
  


#################################2020#################################
epilepsy_febrile_seizure_2020_i <- ms_i_2020 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)

epilepsy_febrile_seizure_2020_o <- ms_o_2020 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)  

epilepsy_febrile_seizure_2020_s <- ms_s_2020 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)    
  
  


#################################2021#################################
epilepsy_febrile_seizure_2021_i <- ms_i_2021 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)

epilepsy_febrile_seizure_2021_o <- ms_o_2021 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)  

epilepsy_febrile_seizure_2021_s <- ms_s_2021 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)    
  
  


#################################2022#################################
epilepsy_febrile_seizure_2022_i <- ms_i_2022 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, DX3, DX4, DX5, DX6, DX7, DX8, DX9,
                                      DX10, DX11, DX12, DX13, DX14, DX15, ADMDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10 |
     DX3 %in% codes_epilepsy_ICD10 | DX4 %in% codes_epilepsy_ICD10 |
     DX5 %in% codes_epilepsy_ICD10 | DX6 %in% codes_epilepsy_ICD10 |
     DX7 %in% codes_epilepsy_ICD10 | DX8 %in% codes_epilepsy_ICD10 |
     DX9 %in% codes_epilepsy_ICD10 | DX10 %in% codes_epilepsy_ICD10 |
     DX11%in% codes_epilepsy_ICD10 | DX12 %in% codes_epilepsy_ICD10 |
     DX13 %in% codes_epilepsy_ICD10 | DX14 %in% codes_epilepsy_ICD10 |
     DX15 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
                                      mutate(SVCDATE=ADMDATE) %>%
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)

epilepsy_febrile_seizure_2022_o <- ms_o_2022 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)  

epilepsy_febrile_seizure_2022_s <- ms_s_2022 %>% 
  filter(ENROLID %in% !!rescue_medication_ID$ENROLID) %>% 
  select(ENROLID, AGE, SEX, DX1, DX2, SVCDATE) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    (DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) ~ 2,
    (DX1 %in% code_febrile_seizures_ICD10 & 
        !(DX1 %in% codes_epilepsy_ICD10 | DX2 %in% codes_epilepsy_ICD10) 
    ) ~ 1,
    TRUE ~ 0)) %>% 
    mutate(across(c(ENROLID, AGE), as.numeric)) %>% 
                                      filter(ENROLID>0) %>%    
  group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  arrange(ENROLID, SVCDATE) %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  collect() %>% 
  mutate(across(SVCDATE, mdy)) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other)    
  



# Patients with a code for epilepsy, febrile seizures, or neither
epilepsy_febrile_seizure <- bind_rows(epilepsy_febrile_seizure_2016_i, epilepsy_febrile_seizure_2016_o, epilepsy_febrile_seizure_2016_s, epilepsy_febrile_seizure_2017_i, epilepsy_febrile_seizure_2017_o, epilepsy_febrile_seizure_2017_s, epilepsy_febrile_seizure_2018_i, epilepsy_febrile_seizure_2018_o, epilepsy_febrile_seizure_2018_s, epilepsy_febrile_seizure_2019_i, epilepsy_febrile_seizure_2019_o, epilepsy_febrile_seizure_2019_s, epilepsy_febrile_seizure_2020_i, epilepsy_febrile_seizure_2020_o, epilepsy_febrile_seizure_2020_s, epilepsy_febrile_seizure_2021_i, epilepsy_febrile_seizure_2021_o, epilepsy_febrile_seizure_2021_s, epilepsy_febrile_seizure_2022_i, epilepsy_febrile_seizure_2022_o, epilepsy_febrile_seizure_2022_s) %>% 
  mutate(epilepsy_febrile_seizure = case_when(
    epilepsy_febrile_seizure_other == "epilepsy" ~ 2,
    epilepsy_febrile_seizure_other == "febrile_seizure" ~ 1,
    TRUE ~ 0)) %>% 
    group_by(ENROLID) %>% 
  mutate(epilepsy_febrile_seizure_other = case_when(
    max(epilepsy_febrile_seizure) == 2 ~ "epilepsy",
    max(epilepsy_febrile_seizure) == 1 ~ "febrile_seizure",
    TRUE ~ "other")) %>% 
  ungroup() %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  select(ENROLID, epilepsy_febrile_seizure_other) %>% 
  collect()
```




Create the data with one row per patient
```{r}
# Dataset
rescue_medication_data <- inflation_adjusted_rescue_medication %>% 
  left_join(demographics, by="ENROLID") %>% 
  left_join(epilepsy_febrile_seizure, by="ENROLID") %>% 
  mutate(epilepsy_febrile_seizure_other = as.factor(case_when(
    is.na(epilepsy_febrile_seizure_other) ~ "other",
    TRUE ~ epilepsy_febrile_seizure_other))) %>% 
  mutate(epilepsy_other = as.factor(case_when(
    epilepsy_febrile_seizure_other=="epilepsy" ~ "epilepsy",
    TRUE ~ "other"))) %>% 
  mutate(age = year_rescue_medication - DOBYR) %>% 
  filter(!is.na(age)) %>%
  mutate(male = as.factor(case_when(SEX == 1 ~ "yes", TRUE ~ "no"))) %>% 
  filter(!is.na(male)) %>% 
  rowwise() %>% 
  mutate(
    AWP_per_unit = case_when(
      rescue_medication=="rectal diazepam" ~ AWP / METQTY,
      rescue_medication=="intranasal midazolam" ~ (AWP / METQTY) * 2,
      rescue_medication=="intranasal diazepam" ~ (AWP / METQTY) * 2
    ),
    patient_cost_per_unit = case_when(
      rescue_medication=="rectal diazepam" ~ sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY,
      rescue_medication=="intranasal midazolam" ~ ((sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY)) * 2,
      rescue_medication=="intranasal diazepam" ~ ((sum(COINS, COPAY, DEDUCT, DISPFEE) / METQTY)) * 2
    )
  ) %>% 
  ungroup() %>% 
  arrange(ENROLID, rescue_medication_prescription_date) %>% 
  group_by(ENROLID) %>% 
  mutate(first_rescue_medication = first(rescue_medication), 
         first_rescue_generic = as.factor(case_when((first(GENIND) == 4 | first(GENIND) == 5) ~ "yes", TRUE ~ "no")),
         first_rescue_date = first(rescue_medication_prescription_date),
         first_rescue_AWP = first(AWP_per_unit),
         first_rescue_patient_cost = first(patient_cost_per_unit),
         last_rescue_medication = last(rescue_medication), 
         last_rescue_generic = as.factor(case_when((last(GENIND) == 4 | last(GENIND) == 5) ~ "yes", TRUE ~ "no")),
         last_rescue_date = last(rescue_medication_prescription_date),
         last_rescue_AWP = last(AWP_per_unit),
         last_rescue_patient_cost = last(patient_cost_per_unit),
         time_from_first_to_last_rescue = as.numeric(last_rescue_date - first_rescue_date) / 365.24219) %>% 
  ungroup() %>% 
  mutate(rural = as.factor(case_when(
    MSA == 0 ~ "yes",
    TRUE ~ "no"))) %>% 
  mutate(region_category = as.factor(case_when(
  REGION == 1 ~ "Northeast",
  REGION == 2 ~ "North Central",
  REGION == 3 ~ "South",
  REGION == 4 ~ "West",
  TRUE ~ "unknown"))) %>% 
  mutate(employment_status_category = as.factor(case_when(
  EESTATU == 1 ~ "full-time",
  TRUE ~ "other"))) %>% 
  mutate(employment_class_category = as.factor(case_when(
  (EECLASS == 1 | EECLASS == 2 | EECLASS == 3) ~ "salary",
  (EECLASS == 4 | EECLASS == 5 | EECLASS == 6) ~ "hourly",
  TRUE ~ "other"))) %>% 
  mutate(change_first_last = as.factor(case_when(
    first_rescue_medication != last_rescue_medication ~ "yes",
    TRUE ~ "no"))) %>% 
  mutate(year_last_rescue = year(last_rescue_date)) %>% 
  select(ENROLID, change_first_last, age, male, first_rescue_medication, first_rescue_generic, first_rescue_AWP, first_rescue_patient_cost, last_rescue_medication, last_rescue_generic, last_rescue_AWP, last_rescue_patient_cost, year_last_rescue, time_from_first_to_last_rescue, region_category, employment_class_category, employment_status_category, rural, epilepsy_febrile_seizure_other, epilepsy_other) %>% 
  distinct(ENROLID, .keep_all = TRUE) %>% 
  collect()
```








## 3. Demographics




Demographics and clinical features
```{r}
# Number of patients
rescue_medication_data %>% nrow()


# Changed
changed <- rescue_medication_data %>% 
  reframe(
  changed = CrossTable(change_first_last)
)


# Age
age <- rescue_medication_data %>% 
  summarize(
    median_age = median(age),
    p25_age = quantile(age, 0.25),
    p75_age = quantile(age, 0.75),
    mean_age = mean(age),
    SD_age = sd(age)
  ) %>% 
  collect()
age

age_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  summarize(
    median_age = median(age),
    p25_age = quantile(age, 0.25),
    p75_age = quantile(age, 0.75),
    mean_age = mean(age),
    SD_age = sd(age)
  ) %>% 
  collect()
age_changed

age_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  summarize(
    median_age = median(age),
    p25_age = quantile(age, 0.25),
    p75_age = quantile(age, 0.75),
    mean_age = mean(age),
    SD_age = sd(age)
  ) %>% 
  collect()
age_not_changed


# Sex
sex <- rescue_medication_data %>% 
  reframe(
  sex = CrossTable(male)
)

sex_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  reframe(
  sex = CrossTable(male)
)

sex_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  reframe(
  sex = CrossTable(male)
)


# Time between first and last rescue medication
length_of_follow_up <- rescue_medication_data %>% 
  summarize(
    median_length_of_follow_up = median(time_from_first_to_last_rescue),
    p25_length_of_follow_up = quantile(time_from_first_to_last_rescue, 0.25),
    p75_length_of_follow_up = quantile(time_from_first_to_last_rescue, 0.75),
    mean_length_of_follow_up = mean(time_from_first_to_last_rescue),
    SD_length_of_follow_up = sd(time_from_first_to_last_rescue)) %>% 
  collect()
length_of_follow_up

length_of_follow_up_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  summarize(
    median_length_of_follow_up = median(time_from_first_to_last_rescue),
    p25_length_of_follow_up = quantile(time_from_first_to_last_rescue, 0.25),
    p75_length_of_follow_up = quantile(time_from_first_to_last_rescue, 0.75),
    mean_length_of_follow_up = mean(time_from_first_to_last_rescue),
    SD_length_of_follow_up = sd(time_from_first_to_last_rescue)) %>% 
  collect()
length_of_follow_up_changed

length_of_follow_up_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  summarize(
    median_length_of_follow_up = median(time_from_first_to_last_rescue),
    p25_length_of_follow_up = quantile(time_from_first_to_last_rescue, 0.25),
    p75_length_of_follow_up = quantile(time_from_first_to_last_rescue, 0.75),
    mean_length_of_follow_up = mean(time_from_first_to_last_rescue),
    SD_length_of_follow_up = sd(time_from_first_to_last_rescue)) %>% 
  collect()
length_of_follow_up_not_changed


# Number of rescue medications during follow-up
n_rescue <- rescue_medication %>% 
  filter(ENROLID %in% !!rescue_medication_data$ENROLID) %>% 
  group_by(ENROLID) %>%  
  mutate(number_rescue = n()) %>% 
  ungroup() %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_n = median(number_rescue),
    p25_n = quantile(number_rescue, 0.25),
    p75_n = quantile(number_rescue, 0.75),
    mean_n = mean(number_rescue),
    SD = sd(number_rescue)) %>% 
  collect()
n_rescue

n_rescue_changed <- rescue_medication %>% 
  filter(ENROLID %in% !!rescue_medication_data[rescue_medication_data$change_first_last=="yes", ]$ENROLID) %>% 
  group_by(ENROLID) %>%  
  mutate(number_rescue = n()) %>% 
  ungroup() %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_n = median(number_rescue),
    p25_n = quantile(number_rescue, 0.25),
    p75_n = quantile(number_rescue, 0.75),
    mean_n = mean(number_rescue),
    SD = sd(number_rescue)) %>% 
  collect()
n_rescue_changed

n_rescue_not_changed <- rescue_medication %>% 
  filter(ENROLID %in% !!rescue_medication_data[rescue_medication_data$change_first_last=="no", ]$ENROLID) %>% 
  group_by(ENROLID) %>%  
  mutate(number_rescue = n()) %>% 
  ungroup() %>% 
  distinct(ENROLID, .keep_all=TRUE) %>% 
  summarize(
    median_n = median(number_rescue),
    p25_n = quantile(number_rescue, 0.25),
    p75_n = quantile(number_rescue, 0.75),
    mean_n = mean(number_rescue),
    SD = sd(number_rescue)) %>% 
  collect()
n_rescue_not_changed


# Year of last rescue benzodiazepine
year_last <- rescue_medication_data %>% 
  reframe(
  year_last = CrossTable(year_last_rescue)
)

year_last_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  reframe(
  year_last = CrossTable(year_last_rescue)
)

year_last_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  reframe(
  year_last = CrossTable(year_last_rescue)
)


# Cause for rescue medication
cause <- rescue_medication_data %>% 
  reframe(
  cause = CrossTable(epilepsy_other)
)

cause_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  reframe(
  cause = CrossTable(epilepsy_other)
)

cause_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  reframe(
  cause = CrossTable(epilepsy_other)
)


# First rescue medication generic
generic <- rescue_medication_data %>% 
  reframe(
  generic = CrossTable(first_rescue_generic)
)

generic_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  reframe(
  generic_changed = CrossTable(first_rescue_generic)
)

generic_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  reframe(
  generic_not_changed = CrossTable(first_rescue_generic)
)


# Rural
rural <- rescue_medication_data %>% 
  reframe(
  rural = CrossTable(rural)
)

rural_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  reframe(
  rural = CrossTable(rural)
)

rural_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  reframe(
  rural = CrossTable(rural)
)


# Region
region <- rescue_medication_data %>% 
  reframe(
  region = CrossTable(region_category)
)

region_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  reframe(
  region = CrossTable(region_category)
)

region_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  reframe(
  region = CrossTable(region_category)
)


# Employment category
employment_status <- rescue_medication_data %>% 
  reframe(
  employment_status = CrossTable(employment_status_category)
)

employment_status_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  reframe(
  employment_status = CrossTable(employment_status_category)
)

employment_status_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  reframe(
  employment_status = CrossTable(employment_status_category)
)


# Employment class
employment_class <- rescue_medication_data %>% 
  reframe(
  employment_class = CrossTable(employment_class_category)
)

employment_class_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  reframe(
  employment_class = CrossTable(employment_class_category)
)

employment_class_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  reframe(
  employment_class = CrossTable(employment_class_category)
)
```








## 4. Main outcomes




Change from rectal diazepam to intranasal rescue medications
```{r}
# Changed
changed <- rescue_medication_data %>% 
  reframe(
  changed = CrossTable(change_first_last)
)

changed_last_rescue_medication <- rescue_medication_data %>% 
  reframe(
  changed_last_rescue_medication = CrossTable(change_first_last, last_rescue_medication)
)


# Changed in 2019
changed_2019 <- rescue_medication_data %>% 
  filter(year_last_rescue == 2019) %>% 
  reframe(
  changed = CrossTable(change_first_last)
)

changed_last_rescue_medication_2019 <- rescue_medication_data %>% 
  filter(year_last_rescue == 2019) %>% 
  reframe(
  changed_last_rescue_medication_2019 = CrossTable(change_first_last, last_rescue_medication)
)


# Changed in 2020
changed_2020 <- rescue_medication_data %>% 
  filter(year_last_rescue == 2020) %>% 
  reframe(
  changed = CrossTable(change_first_last)
)

changed_last_rescue_medication_2020 <- rescue_medication_data %>% 
  filter(year_last_rescue == 2020) %>% 
  reframe(
  changed_last_rescue_medication_2020 = CrossTable(change_first_last, last_rescue_medication)
)


# Changed in 2021
changed_2021 <- rescue_medication_data %>% 
  filter(year_last_rescue == 2021) %>% 
  reframe(
  changed = CrossTable(change_first_last)
)

changed_last_rescue_medication_2021 <- rescue_medication_data %>% 
  filter(year_last_rescue == 2021) %>% 
  reframe(
  changed_last_rescue_medication_2021 = CrossTable(change_first_last, last_rescue_medication)
)


# Changed in 2022
changed_2022 <- rescue_medication_data %>% 
  filter(year_last_rescue == 2022) %>% 
  reframe(
  changed = CrossTable(change_first_last)
)

changed_last_rescue_medication_2022 <- rescue_medication_data %>% 
  filter(year_last_rescue == 2022) %>% 
  reframe(
  changed_last_rescue_medication_2022 = CrossTable(change_first_last, last_rescue_medication)
)
```




Figure on the change from rectal diazepam to intranasal rescue medications
```{r}
# Data for figure 
rescue_medication_data_for_figure <- rescue_medication_data %>% 
  select(ENROLID, first_rescue_medication, last_rescue_medication, year_last_rescue) %>% 
  group_by(year_last_rescue) %>% 
  mutate(total_last_rescue_medications_per_year = n()) %>% 
  ungroup() %>% 
  group_by(year_last_rescue, last_rescue_medication) %>% 
  mutate(proportion_rescue_medication = n() / total_last_rescue_medications_per_year) %>% 
  distinct(year_last_rescue, last_rescue_medication, .keep_all=TRUE) %>% 
  ungroup() %>% 
  group_by(year_last_rescue) %>% 
  arrange(desc(proportion_rescue_medication), .by_group=TRUE) %>% 
  select(year_last_rescue, last_rescue_medication, proportion_rescue_medication) %>% 
  collect()




# Last rescue medication per year figure
rescue_medication_use_per_year_plot <- ggplot(data=rescue_medication_data_for_figure,
                                aes(x=year_last_rescue, y=proportion_rescue_medication, color=last_rescue_medication)) + 
  scale_color_manual(values = c("rectal diazepam" = "red",
                                "intranasal midazolam"="purple4",
                                "intranasal diazepam"="greenyellow")) +
  geom_line(lwd=1.5) + 
  theme(legend.position="none", panel.background=element_blank(), panel.grid.major=element_blank(), panel.grid.minor=element_blank(), panel.border=element_blank(), axis.ticks=element_blank(),
        axis.text=element_text(size=14, face="bold"), axis.text.x=element_text(angle=90, hjust=1),
        axis.title=element_text(size=20, face="bold")) +
  scale_x_continuous(name="Year", breaks=2019:2022) +
  scale_y_continuous(name="Proportion", breaks=seq(0, 1, 0.2), limits = c(0, 1))
rescue_medication_use_per_year_plot
```




Factors associated with switching
```{r}
# Regression on change to intranasal
logistic_regression_rescue_medication_switch <- glm(change_first_last ~ age + male + relevel(epilepsy_other, ref="other") + relevel(first_rescue_generic, ref="no") + year_last_rescue + relevel(rural, ref="yes") + relevel(region_category, ref="West") + relevel(employment_status_category, ref="other") + relevel(employment_class_category, ref="hourly"), data = rescue_medication_data, family = "binomial")

summary(logistic_regression_rescue_medication_switch)

exp(cbind(OR=coef(logistic_regression_rescue_medication_switch), confint(logistic_regression_rescue_medication_switch)))
```




Average wholesale price
```{r}
# AWP of initial versus final rescue medication
AWP_first <- rescue_medication_data %>% 
  summarize(
    median_AWP_first = median(first_rescue_AWP, na.rm=TRUE),
    p25_AWP_first = quantile(first_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_first = quantile(first_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_first = mean(first_rescue_AWP, na.rm=TRUE),
    SD_AWP_first = sd(first_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_first


AWP_last <- rescue_medication_data %>% 
  summarize(
    median_AWP_last = median(last_rescue_AWP, na.rm=TRUE),
    p25_AWP_last = quantile(last_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_last = quantile(last_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_last = mean(last_rescue_AWP, na.rm=TRUE),
    SD_AWP_last = sd(last_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_last


wilcox.test(rescue_medication_data$first_rescue_AWP, rescue_medication_data$last_rescue_AWP, alternative="two.sided", paired=TRUE)




# AWP of initial versus rescue medication among those who changed
AWP_first_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  summarize(
    median_AWP_first = median(first_rescue_AWP, na.rm=TRUE),
    p25_AWP_first = quantile(first_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_first = quantile(first_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_first = mean(first_rescue_AWP, na.rm=TRUE),
    SD_AWP_first = sd(first_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_first_changed


AWP_last_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  summarize(
    median_AWP_last = median(last_rescue_AWP, na.rm=TRUE),
    p25_AWP_last = quantile(last_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_last = quantile(last_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_last = mean(last_rescue_AWP, na.rm=TRUE),
    SD_AWP_last = sd(last_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_last_changed


wilcox.test(rescue_medication_data[rescue_medication_data$change_first_last=="yes", ]$first_rescue_AWP, rescue_medication_data[rescue_medication_data$change_first_last=="yes", ]$last_rescue_AWP, alternative="two.sided", paired=TRUE)




# AWP of initial versus rescue medication among those who did not change
AWP_first_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  summarize(
    median_AWP_first = median(first_rescue_AWP, na.rm=TRUE),
    p25_AWP_first = quantile(first_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_first = quantile(first_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_first = mean(first_rescue_AWP, na.rm=TRUE),
    SD_AWP_first = sd(first_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_first_not_changed


AWP_last_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  summarize(
    median_AWP_last = median(last_rescue_AWP, na.rm=TRUE),
    p25_AWP_last = quantile(last_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_last = quantile(last_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_last = mean(last_rescue_AWP, na.rm=TRUE),
    SD_AWP_last = sd(last_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_last_not_changed


wilcox.test(rescue_medication_data[rescue_medication_data$change_first_last=="no", ]$first_rescue_AWP, rescue_medication_data[rescue_medication_data$change_first_last=="no", ]$last_rescue_AWP, alternative="two.sided", paired=TRUE)




### Considering only brand-name diazepam

# Restrict the data to only those with first rectal diazepam brand name
rescue_medication_data_only_brand_name_initial_diazepam_data <- rescue_medication_data %>% 
  filter(first_rescue_generic=="no") %>%
  collect()

# AWP of initial versus final rescue medication
AWP_first_only_brand_name_initial_diazepam <- rescue_medication_data_only_brand_name_initial_diazepam_data %>% 
  summarize(
    median_AWP_first = median(first_rescue_AWP, na.rm=TRUE),
    p25_AWP_first = quantile(first_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_first = quantile(first_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_first = mean(first_rescue_AWP, na.rm=TRUE),
    SD_AWP_first = sd(first_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_first_only_brand_name_initial_diazepam


AWP_last_only_brand_name_initial_diazepam <- rescue_medication_data_only_brand_name_initial_diazepam_data %>% 
  summarize(
    median_AWP_last = median(last_rescue_AWP, na.rm=TRUE),
    p25_AWP_last = quantile(last_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_last = quantile(last_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_last = mean(last_rescue_AWP, na.rm=TRUE),
    SD_AWP_last = sd(last_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_last_only_brand_name_initial_diazepam


wilcox.test(rescue_medication_data_only_brand_name_initial_diazepam_data$first_rescue_AWP, rescue_medication_data_only_brand_name_initial_diazepam_data$last_rescue_AWP, alternative="two.sided", paired=TRUE)




# AWP of initial versus rescue medication among those who changed
AWP_first_changed_only_brand_name_initial_diazepam <- rescue_medication_data_only_brand_name_initial_diazepam_data %>% 
  filter(change_first_last=="yes") %>% 
  summarize(
    median_AWP_first = median(first_rescue_AWP, na.rm=TRUE),
    p25_AWP_first = quantile(first_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_first = quantile(first_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_first = mean(first_rescue_AWP, na.rm=TRUE),
    SD_AWP_first = sd(first_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_first_changed_only_brand_name_initial_diazepam


AWP_last_changed_only_brand_name_initial_diazepam <- rescue_medication_data_only_brand_name_initial_diazepam_data %>% 
  filter(change_first_last=="yes") %>% 
  summarize(
    median_AWP_last = median(last_rescue_AWP, na.rm=TRUE),
    p25_AWP_last = quantile(last_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_last = quantile(last_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_last = mean(last_rescue_AWP, na.rm=TRUE),
    SD_AWP_last = sd(last_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_last_changed_only_brand_name_initial_diazepam


wilcox.test(rescue_medication_data_only_brand_name_initial_diazepam_data[rescue_medication_data_only_brand_name_initial_diazepam_data$change_first_last=="yes", ]$first_rescue_AWP, rescue_medication_data_only_brand_name_initial_diazepam_data[rescue_medication_data_only_brand_name_initial_diazepam_data$change_first_last=="yes", ]$last_rescue_AWP, alternative="two.sided", paired=TRUE)




# AWP of initial versus rescue medication among those who did not change
AWP_first_not_changed_only_brand_name_initial_diazepam <- rescue_medication_data_only_brand_name_initial_diazepam_data %>% 
  filter(change_first_last=="no") %>% 
  summarize(
    median_AWP_first = median(first_rescue_AWP, na.rm=TRUE),
    p25_AWP_first = quantile(first_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_first = quantile(first_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_first = mean(first_rescue_AWP, na.rm=TRUE),
    SD_AWP_first = sd(first_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_first_not_changed_only_brand_name_initial_diazepam


AWP_last_not_changed_only_brand_name_initial_diazepam <- rescue_medication_data_only_brand_name_initial_diazepam_data %>% 
  filter(change_first_last=="no") %>% 
  summarize(
    median_AWP_last = median(last_rescue_AWP, na.rm=TRUE),
    p25_AWP_last = quantile(last_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_last = quantile(last_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_last = mean(last_rescue_AWP, na.rm=TRUE),
    SD_AWP_last = sd(last_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_last_not_changed_only_brand_name_initial_diazepam


wilcox.test(rescue_medication_data_only_brand_name_initial_diazepam_data[rescue_medication_data_only_brand_name_initial_diazepam_data$change_first_last=="no", ]$first_rescue_AWP, rescue_medication_data_only_brand_name_initial_diazepam_data[rescue_medication_data_only_brand_name_initial_diazepam_data$change_first_last=="no", ]$last_rescue_AWP, alternative="two.sided", paired=TRUE)




### Considering only generic diazepam

# Restrict the data to only those with first rectal diazepam generic
rescue_medication_data_only_generic_initial_diazepam_data <- rescue_medication_data %>% 
  filter(first_rescue_generic=="yes") %>%
  collect()

# AWP of initial versus final rescue medication
AWP_first_only_generic_initial_diazepam <- rescue_medication_data_only_generic_initial_diazepam_data %>% 
  summarize(
    median_AWP_first = median(first_rescue_AWP, na.rm=TRUE),
    p25_AWP_first = quantile(first_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_first = quantile(first_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_first = mean(first_rescue_AWP, na.rm=TRUE),
    SD_AWP_first = sd(first_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_first_only_generic_initial_diazepam


AWP_last_only_generic_initial_diazepam <- rescue_medication_data_only_generic_initial_diazepam_data %>% 
  summarize(
    median_AWP_last = median(last_rescue_AWP, na.rm=TRUE),
    p25_AWP_last = quantile(last_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_last = quantile(last_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_last = mean(last_rescue_AWP, na.rm=TRUE),
    SD_AWP_last = sd(last_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_last_only_generic_initial_diazepam


wilcox.test(rescue_medication_data_only_generic_initial_diazepam_data$first_rescue_AWP, rescue_medication_data_only_generic_initial_diazepam_data$last_rescue_AWP, alternative="two.sided", paired=TRUE)




# AWP of initial versus rescue medication among those who changed
AWP_first_changed_only_generic_initial_diazepam <- rescue_medication_data_only_generic_initial_diazepam_data %>% 
  filter(change_first_last=="yes") %>% 
  summarize(
    median_AWP_first = median(first_rescue_AWP, na.rm=TRUE),
    p25_AWP_first = quantile(first_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_first = quantile(first_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_first = mean(first_rescue_AWP, na.rm=TRUE),
    SD_AWP_first = sd(first_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_first_changed_only_generic_initial_diazepam


AWP_last_changed_only_generic_initial_diazepam <- rescue_medication_data_only_generic_initial_diazepam_data %>% 
  filter(change_first_last=="yes") %>% 
  summarize(
    median_AWP_last = median(last_rescue_AWP, na.rm=TRUE),
    p25_AWP_last = quantile(last_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_last = quantile(last_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_last = mean(last_rescue_AWP, na.rm=TRUE),
    SD_AWP_last = sd(last_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_last_changed_only_generic_initial_diazepam


wilcox.test(rescue_medication_data_only_generic_initial_diazepam_data[rescue_medication_data_only_generic_initial_diazepam_data$change_first_last=="yes", ]$first_rescue_AWP, rescue_medication_data_only_generic_initial_diazepam_data[rescue_medication_data_only_generic_initial_diazepam_data$change_first_last=="yes", ]$last_rescue_AWP, alternative="two.sided", paired=TRUE)




# AWP of initial versus rescue medication among those who did not change
AWP_first_not_changed_only_generic_initial_diazepam <- rescue_medication_data_only_generic_initial_diazepam_data %>% 
  filter(change_first_last=="no") %>% 
  summarize(
    median_AWP_first = median(first_rescue_AWP, na.rm=TRUE),
    p25_AWP_first = quantile(first_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_first = quantile(first_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_first = mean(first_rescue_AWP, na.rm=TRUE),
    SD_AWP_first = sd(first_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_first_not_changed_only_generic_initial_diazepam


AWP_last_not_changed_only_generic_initial_diazepam <- rescue_medication_data_only_generic_initial_diazepam_data %>% 
  filter(change_first_last=="no") %>% 
  summarize(
    median_AWP_last = median(last_rescue_AWP, na.rm=TRUE),
    p25_AWP_last = quantile(last_rescue_AWP, 0.25, na.rm=TRUE),
    p75_AWP_last = quantile(last_rescue_AWP, 0.75, na.rm=TRUE),
    mean_AWP_last = mean(last_rescue_AWP, na.rm=TRUE),
    SD_AWP_last = sd(last_rescue_AWP, na.rm=TRUE)) %>% 
  collect()
AWP_last_not_changed_only_generic_initial_diazepam


wilcox.test(rescue_medication_data_only_generic_initial_diazepam_data[rescue_medication_data_only_generic_initial_diazepam_data$change_first_last=="no", ]$first_rescue_AWP, rescue_medication_data_only_generic_initial_diazepam_data[rescue_medication_data_only_generic_initial_diazepam_data$change_first_last=="no", ]$last_rescue_AWP, alternative="two.sided", paired=TRUE)
```




Patient cost
```{r}
# Patient cost of initial versus final rescue medication
patient_cost_first <- rescue_medication_data %>% 
  summarize(
    median_patient_cost_first = median(first_rescue_patient_cost, na.rm=TRUE),
    p25_patient_cost_first = quantile(first_rescue_patient_cost, 0.25, na.rm=TRUE),
    p75_patient_cost_first = quantile(first_rescue_patient_cost, 0.75, na.rm=TRUE),
    mean_patient_cost_first = mean(first_rescue_patient_cost, na.rm=TRUE),
    SD_patient_cost_first = sd(first_rescue_patient_cost, na.rm=TRUE)) %>% 
  collect()
patient_cost_first


patient_cost_last <- rescue_medication_data %>% 
  summarize(
    median_patient_cost_last = median(last_rescue_patient_cost, na.rm=TRUE),
    p25_patient_cost_last = quantile(last_rescue_patient_cost, 0.25, na.rm=TRUE),
    p75_patient_cost_last = quantile(last_rescue_patient_cost, 0.75, na.rm=TRUE),
    mean_patient_cost_last = mean(last_rescue_patient_cost, na.rm=TRUE),
    SD_patient_cost_last = sd(last_rescue_patient_cost, na.rm=TRUE)) %>% 
  collect()
patient_cost_last


wilcox.test(rescue_medication_data$first_rescue_patient_cost, rescue_medication_data$last_rescue_patient_cost, alternative="two.sided", paired=TRUE)




# Patient cost of initial versus rescue medication among those who changed
patient_cost_first_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  summarize(
    median_patient_cost_first = median(first_rescue_patient_cost, na.rm=TRUE),
    p25_patient_cost_first = quantile(first_rescue_patient_cost, 0.25, na.rm=TRUE),
    p75_patient_cost_first = quantile(first_rescue_patient_cost, 0.75, na.rm=TRUE),
    mean_patient_cost_first = mean(first_rescue_patient_cost, na.rm=TRUE),
    SD_patient_cost_first = sd(first_rescue_patient_cost, na.rm=TRUE)) %>% 
  collect()
patient_cost_first_changed


patient_cost_last_changed <- rescue_medication_data %>% 
  filter(change_first_last=="yes") %>% 
  summarize(
    median_patient_cost_last = median(last_rescue_patient_cost, na.rm=TRUE),
    p25_patient_cost_last = quantile(last_rescue_patient_cost, 0.25, na.rm=TRUE),
    p75_patient_cost_last = quantile(last_rescue_patient_cost, 0.75, na.rm=TRUE),
    mean_patient_cost_last = mean(last_rescue_patient_cost, na.rm=TRUE),
    SD_patient_cost_last = sd(last_rescue_patient_cost, na.rm=TRUE)) %>% 
  collect()
patient_cost_last_changed


wilcox.test(rescue_medication_data[rescue_medication_data$change_first_last=="yes", ]$first_rescue_patient_cost, rescue_medication_data[rescue_medication_data$change_first_last=="yes", ]$last_rescue_patient_cost, alternative="two.sided", paired=TRUE)




# Patient cost of initial versus rescue medication among those who did not change
patient_cost_first_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  summarize(
    median_patient_cost_first = median(first_rescue_patient_cost, na.rm=TRUE),
    p25_patient_cost_first = quantile(first_rescue_patient_cost, 0.25, na.rm=TRUE),
    p75_patient_cost_first = quantile(first_rescue_patient_cost, 0.75, na.rm=TRUE),
    mean_patient_cost_first = mean(first_rescue_patient_cost, na.rm=TRUE),
    SD_patient_cost_first = sd(first_rescue_patient_cost, na.rm=TRUE)) %>% 
  collect()
patient_cost_first_not_changed


patient_cost_last_not_changed <- rescue_medication_data %>% 
  filter(change_first_last=="no") %>% 
  summarize(
    median_patient_cost_last = median(last_rescue_patient_cost, na.rm=TRUE),
    p25_patient_cost_last = quantile(last_rescue_patient_cost, 0.25, na.rm=TRUE),
    p75_patient_cost_last = quantile(last_rescue_patient_cost, 0.75, na.rm=TRUE),
    mean_patient_cost_last = mean(last_rescue_patient_cost, na.rm=TRUE),
    SD_patient_cost_last = sd(last_rescue_patient_cost, na.rm=TRUE)) %>% 
  collect()
patient_cost_last_not_changed


wilcox.test(rescue_medication_data[rescue_medication_data$change_first_last=="no", ]$first_rescue_patient_cost, rescue_medication_data[rescue_medication_data$change_first_last=="no", ]$last_rescue_patient_cost, alternative="two.sided", paired=TRUE)
```








## 5. Disconnect from the database




Disconnect from the database
```{r}
# Disconnect
dbDisconnect(MarketScan)
```

